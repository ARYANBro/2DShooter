[gd_scene load_steps=8 format=2]

[ext_resource path="res://Assets/Enemy/Enemy.tscn" type="PackedScene" id=1]

[sub_resource type="CSharpScript" id=1]
script/source = "using Godot;
using System;

public class AcidEnemy : Enemy
{
    float startTime = 3;
    float time;
    bool takeDamage = true;

    public override void _Ready()
    {
        player = GetTree().CurrentScene.GetNode<Player>(\"Player\");
        GD.Print(player.Name);
        time = startTime;
    }

    public override void _Process(float delta)
    {
        GetMovementInput(delta);
    }

    public override void _PhysicsProcess(float delta)
    {
        velocity = MoveAndSlide(velocity);
    }

    public override void TakeDamage(float damage)
    {
        Hp -= damage;
        if (Hp <= 0)
        {
            var cameraShake = GetTree().CurrentScene.GetNode<CameraShake>(\"MainCam\");

            cameraShake.StartShake();

            EmitSignal(\"SEnemyDied\", 10);
            EmitSignal(\"SSpawnPoints\", GlobalPosition, 10, new Vector2(1f, 1f));

            GetParent().QueueFree();
        }

        GetNode<Sprite>(\"EnemySprite\").Material.Set(\"shader_param/hit\", true);
        GetTree().CreateTimer(0.1f).Connect(\"timeout\", this, \"OnHitTimerTimeout\");
    }

    public override void Shoot(float delta) {}
}"

[sub_resource type="Shader" id=2]
code = "shader_type canvas_item;

uniform vec4 color : hint_color;
uniform vec4 hitColor : hint_color;
uniform bool hit;

void fragment()
{
	if (hit)
		COLOR = hitColor;
	else 
		COLOR.r = color.r;
		COLOR.g = color.g * clamp(sin(TIME) + 1.4 / 2.0, 1.2, 2.0); 
		COLOR.b = color.b;
}"
custom_defines = ""

[sub_resource type="ShaderMaterial" id=3]
resource_local_to_scene = true
shader = SubResource( 2 )
shader_param/color = Color( 0.384314, 0.639216, 0.211765, 1 )
shader_param/hitColor = Color( 1, 1, 1, 1 )
shader_param/hit = false

[sub_resource type="ProxyTexture" id=4]

[sub_resource type="ParticlesMaterial" id=5]
emission_shape = 2
emission_box_extents = Vector3( 7, 7, 1 )
flag_disable_z = true
gravity = Vector3( 0, 98, 0 )
orbit_velocity = 0.0
orbit_velocity_random = 0.0
color = Color( 0.211765, 0.505882, 0.164706, 1 )

[sub_resource type="RectangleShape2D" id=6]
extents = Vector2( 6.9362, 6.96311 )

[node name="Enemy" instance=ExtResource( 1 )]

[node name="Enemy" parent="." index="0"]
collision_mask = 2147483655
script = SubResource( 1 )
stoppingDistance = 15
retreatDistance = 15

[node name="EnemySprite" parent="Enemy" index="0"]
material = SubResource( 3 )
texture = SubResource( 4 )

[node name="Particles2D" type="Particles2D" parent="Enemy" index="3"]
position = Vector2( 0.393726, 3.70102 )
amount = 3
lifetime = 2.0
process_material = SubResource( 5 )

[node name="AcidEnemyCollision" type="Area2D" parent="Enemy" index="4"]
collision_layer = 0
collision_mask = 2147483649

[node name="CollisionShape2D" type="CollisionShape2D" parent="Enemy/AcidEnemyCollision" index="0"]
shape = SubResource( 6 )
[connection signal="body_entered" from="Enemy/AcidEnemyCollision" to="Enemy" method="OnAcidEnemyBodyCollided"]
